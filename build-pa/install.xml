<?xml version="1.0" encoding="utf-8" ?>
<!--
$Id: install.xml 4757 2008-05-15 20:43:31Z zengje $
$HeadURL: http://gforge.nci.nih.gov/svnroot/pa-ear/trunk/software/install.xml $
-->
<project name="pa-ear-pa-ear-installer" default="upgrade" basedir="."
    xmlns:ivy="antlib:org.apache.ivy.ant"
    >
    <description>
        Used to install and configure the pre-built distributions for the various applications subsystems or components
    </description>

    <!-- Properties file related properties and tasks -->
    <property environment="env" />
    <property file="local.properties" />
    <property file="project.properties"/>
    <property name="properties.file" value="${basedir}/install.properties"/>
    <echo message="Using properties file of ${properties.file}."/>
    <available file="${properties.file}" property="properties.file.exists" />
    <fail unless="properties.file.exists" message="The properties.file ${properties.file} does not exist, please make sure that you pass in an accurate file name with the 'ant -Dproperties.file=somepath/somefile', otherwise the build will fail."/>
    <replaceregexp file="${properties.file}" byline="true" match="^([\w\d.]+)=(.*[\w\d\/\{\}\\]+)[ \t]+\r*$" replace="\1=\2"/>
    <replaceregexp file="${properties.file}" byline="true" match="^([\w\d.]+)=[ \t]+(.*[\w\d\/\{\}\\]+)\r*$" replace="\1=\2"/>
    <property file="${properties.file}" />
    <!-- Set application.base.path based on platform -->
    <condition property="application.base.path" value="${application.base.path.linux}">
        <or>
            <os family="unix" />
            <os family="mac" />
        </or>
    </condition>

    <condition property="application.base.path" value="${application.base.path.windows}">
        <os family="windows" />
    </condition>
    <echo message="application.base.path=${application.base.path}"/>
    <property name="jboss.home" value="${application.base.path}/${jboss.relative.path}"/>
    <property name="tomcat.home" value="${application.base.path}/${tomcat.relative.path}"/>
    <property name="doc.upload.filepath.loc" value="${application.base.path}/${doc.upload.filepath.relative.dir}"/>

    <!--OS Temp dir -->
    <condition property="os.temp.dir" value="/tmp">
        <or>
            <os family="unix" />
            <os family="mac" />
        </or>
    </condition>

    <condition property="os.temp.dir" value="c:/temp">
        <os family="windows" />
    </condition>


    <!-- Generic properties -->
    <property name="log.dir" value="${basedir}/logs" />
    <property name="working.dir" value="${basedir}/working" />
    <property name="temp.dir" value="${working.dir}/temp" />

    <!-- Install Time properties -->
    <!-- Source and target directories -->
    <property name="bda-utils.dir" value="bda-utils" />
    <property name="pa-container-jar.dist.dir" value="${basedir}/${pa-container-jar.dist.relative.dir}" />
    <property name="tools.dir" value="${basedir}/${tools.dist.relative.dir}" />
    <property name="common.dir.src" value="${basedir}/${common.dist.relative.dir}" />
    <property name="common.dir.dest" value="${working.dir}/${common.dist.relative.dir}" />
    <property name="jboss-conf.dir.dest" value="${working.dir}/${jboss-conf.dist.relative.dir}" />
    <property name="db.dir.src" value="${basedir}/${db.dist.relative.dir}" />
    <property name="db.dir.dest" value="${working.dir}/${db.dist.relative.dir}" />
    <property name="db-install.dir.dest" value="${working.dir}/${db-install.dist.relative.dir}" />
    <property name="db-upgrade.dir.dest" value="${working.dir}/${db-upgrade.dist.relative.dir}" />
    <property name="jboss-conf.dir.src" value="${basedir}/${jboss-conf.dist.relative.dir}" />

    <!-- Jboss configurtion related properties -->
    <property name="jboss.binding.template.location" value="${bda-utils.dir}/resource/${jboss.template.relative.dir}/bindings.xml"/>
    <property name="jboss.service.template.location" value="${bda-utils.dir}/resource/${jboss.template.relative.dir}/jboss-service.xml"/>

    <!-- added for updated secure grid ssaksa 090826 -->
     <property name="sync-gts.dir" location="${basedir}/${sync-gts.dist.relative.dir}"/>
     <property name="sync-gts.build.dir" location="${sync-gts.dir}/syncgts"/>
     <property name="cagrid-target.dir" location="${sync-gts.dir}/cagrid-target"/>
     <property name="grid.dir.dest.jboss" value="wsrf.war" />

    <!-- *-ds.xml and WAR -->
    <property name="pa-ear.dir.dist" value="${basedir}/${pa-ear.dist.relative.dir}" />
    <property name="pa-ear.ds.file" value="pa-ds.xml" />
    <property name="pa-ear.ear.file" value="pa.ear" />
    <property name="accrual-ear.dir.dist" value="${basedir}/${pa-ear.dist.relative.dir}" />
    <property name="accrual-ear.ear.file" value="accrual.ear" />

    <!-- Default to false, properties can override -->
    <property name="grid.secure.enable" value="false"/>
    <property name="jboss.ssl.enable" value="false"/>
    <property name="tomcat.ssl.enable" value="false"/>

    <property name="grid.resource.dir" value="${working.dir}/${grid.dist.relative.dir}" />
    <property name="grid.application.dir" value="${working.dir}/grid-application" />
    <property name="grid.resource.dir.src" value="${basedir}/${grid.dist.relative.dir}" />
    <property name="resource.file.jboss-globus-lib" value="jboss-globus-libs-cagrid1_1.zip" />
    <property name="resource.file.jboss-globus-war" value="jboss-globus-wsrf-war-cagrid1_1.zip" />

    <property name="pa-grid.dir.dist" value="${basedir}/${pa-grid.dist.relative.dir}" />
    <property name="pa-grid.dir.src" value="${basedir}/${pa-grid.dist.relative.dir}" />
    <property name="pa-grid.dir.target" value="wsrf.war" />
    <property name="pa-grid.introduce.skeleton.service.name" value="PAServices"/>

    <property name="pa-grid-legacy.dir.dist" value="${basedir}/${pa-grid-legacy.dist.relative.dir}" />
    <property name="pa-grid-legacy.dir.src" value="${basedir}/${pa-grid-legacy.dist.relative.dir}" />
    <property name="pa-grid-legacy.dir.target" value="wsrf.war" />
    <property name="pa-grid-legacy.introduce.skeleton.service.name" value="PAServices"/>

    <property name="outcomes-grid.dir.dist" value="${basedir}/${outcomes-grid.dist.relative.dir}" />
    <property name="outcomes-grid.dir.src" value="${basedir}/${outcomes-grid.dist.relative.dir}" />
    <property name="outcomes-grid.dir.target" value="wsrf.war" />
    <property name="outcomes-grid.introduce.skeleton.service.name" value="OutcomesServices"/>

    <!-- Paths -->
    <path id="bda-utils.classpath">
        <fileset dir="${bda-utils.dir}">
            <include name="**/*.jar" />
        </fileset>
    </path>
    <!-- Task definitions -->
    <taskdef uri="antlib:org.apache.ant.antunit" resource="org/apache/ant/antunit/antlib.xml">
        <classpath>
            <pathelement location="${bda-utils.dir}/antunit-1.0.jar" />
        </classpath>
    </taskdef>
    <taskdef name="xmlconfig" classname="com.xmlconfig.anttask.XmlConfig" classpathref="bda-utils.classpath" />
    <taskdef name="for" classname="net.sf.antcontrib.logic.ForTask">
        <classpath>
            <pathelement location="${bda-utils.dir}/ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="${bda-utils.dir}/ant-contrib-1.0b3.jar"/>
            <pathelement location="${bda-utils.dir}/bcel-5.1.jar"/>
            <pathelement location="${bda-utils.dir}/commons-httpclient-3.0.1.jar"/>
            <pathelement location="${bda-utils.dir}/commons-logging-1.0.4.jar"/>
            <pathelement location="${bda-utils.dir}/ivy-1.3.1.jar"/>
        </classpath>
    </taskdef>
    <taskdef resource="liquibasetasks.properties" classpathref="bda-utils.classpath"/>
    <taskdef name="groovy" classname="org.codehaus.groovy.ant.Groovy" classpathref="bda-utils.classpath"/>

    <!-- Conditionals -->
    <available file="${jboss.home}/server/${jboss.server.name}/conf/jboss-service.xml" property="jboss.exists"/>
    <available file="${jboss.home}/server/${pagrid.jboss.server.name}/conf/jboss-service.xml" property="jboss.exists"/>
    <available file="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/conf/jboss-service.xml" property="jboss.exists"/>
    <!-- pa-ear can use either Oracle or MySQL or PostgreSQL as its database platform, this is controled by the database.type property.  Based on the value of this property sent several variables for use during install -->
    <switch value="${database.type}">
        <case value="postgresql">
            <property name="database.dialect" value="org.hibernate.dialect.PostgreSQLDialect"/>
            <property name="database.driver.file" value="${bda-utils.dir}/postgresql-jdbc3-8.3-603.jar"/>
            <property name="database.driver" value="org.postgresql.Driver"/>
            <property name="db-upgrade.list.file" value="${db-upgrade.postgresql.list.file}"/>
            <property name="db-upgrade.conf.file" value="${db-upgrade.postgresql.conf.file}"/>
        </case>
        <default>
            <fail message="Invalid database type ${database.type}"/>
        </default>
    </switch>

    <path id="jdbc.driver.classpath">
        <pathelement location="${database.driver.file}"/>
    </path>

    <!-- Added to convert location to file and path -->
    <basename file="${jboss.ssl.keystore.location}" property="jboss.ssl.keystore.file"/>
    <dirname file="${jboss.ssl.keystore.location}" property="jboss.ssl.keystore.dir"/>
    <basename file="${tomcat.ssl.keystore.location}" property="tomcat.ssl.keystore.file"/>
    <dirname file="${tomcat.ssl.keystore.location}" property="tomcat.ssl.keystore.dir"/>
    <basename file="${grid.secure.cert.location}" property="grid.secure.cert.file"/>
    <dirname file="${grid.secure.cert.location}" property="grid.secure.dir"/>
    <basename file="${grid.secure.key.location}" property="grid.secure.key.file"/>

    <basename file="${pagrid.grid.secure.cert.location}" property="pagrid.grid.secure.cert.file"/>
    <dirname file="${pagrid.grid.secure.cert.location}" property="pagrid.grid.secure.dir"/>
    <basename file="${pagrid.grid.secure.key.location}" property="pagrid.grid.secure.key.file"/>

    <basename file="${outcomes-grid.grid.secure.cert.location}" property="outcomes-grid.grid.secure.cert.file"/>
    <dirname file="${outcomes-grid.grid.secure.cert.location}" property="outcomes-grid.grid.secure.dir"/>
    <basename file="${outcomes-grid.grid.secure.key.location}" property="outcomes-grid.grid.secure.key.file"/>

    <!-- figure out whether to use install-properties.template or upgrade-proprties.template based on the name of the properties file -->
    <propertyregex property="properties.file.type"
        input="${properties.file}"
        regexp=".*(install|upgrade).*"
        select="\1"
        />
    <echo message="Properties file type = ${properties.file.type}"/>
    <switch value="${properties.file.type}">
        <case value="install">
            <property name="properties.template.file" value="install-properties.template" />
        </case>
        <case value="upgrade">
            <property name="properties.template.file" value="upgrade-properties.template" />
        </case>
        <default>
            <fail message="Property file name must include 'install' or 'upgrade' so it can be determined which properties template should be used. If you are not certain include 'upgrade' in the name of your proeprties file."/>
        </default>
    </switch>

    <!-- Includes-->
    <import file="${bda-utils.dir}/bda-build-utils-${bda.version}.xml" />

    <!-- Read db configs from existing ds.xml if it exists for use in upgrade installs, if already set in properties file values from properties file will be used -->
    <available file="${jboss.home}/server/${jboss.server.name}/deploy/${pa-ear.ds.file}" property="ds.exists"/>
    <if>
        <isset property="ds.exists"/>
        <then>
            <jboss-read-dbconfig
                jboss.ds-xml.file="${pa-ear.ds.file}"
                />
        </then>
        <else>
            <echo message="Warning- could not find ${jboss.home}/server/${jboss.server.name}/deploy/${pa-ear.ds.file}"/>
        </else>
    </if>

    <!-- There is any issue with copying files with a filtersfile, any properties with a value of
        another property do not get expanded (xx=${yy} @xx@ will be replaced with ${yy} not the
        value).  I have defined a filter set below for these properties, I then two two copies
        one to the resource.dir.temp using the filterset and then one to the desired directory
        with the filter file.  If you add new properties that refer to other properties in the
        properties file please add them to the filterset-pre below.
         Also you should include properties that are declared in this file, like database info below.
    -->
    <property name="resource.dir.temp" value="${working.dir}/tmp" />
    <filterset id="filterset.pre">
        <filter token="application.base.path" value="${application.base.path}"/>
        <filter token="application.url" value="${application.url}"/>
        <filter token="database.url" value="${database.url}"/>
        <filter token="database.system.url" value="${database.system.url}"/>
        <filter token="jboss.home" value="${jboss.home}"/>
        <!-- added internal properties that may be used in a filtered copy -->
        <filter token="db-upgrade.run.dir" value="${db-upgrade.dir.dest}/${database.type}"/>
        <filter token="database.driver" value="${database.driver}"/>
        <filter token="database.dialect" value="${database.dialect}"/>
        <filter token="hibernate.cfg.file.path" value="${hibernate.cfg.file.path}"/>
        <filter token="grid" value="${hibernate.cfg.file.path}"/>
        <filter token="gridServicePrincipal" value="${pagrid.jndi.principal}"/>
        <filter token="gridServiceCredential" value="${pagrid.jndi.credentials.encrytped}"/>
    </filterset>


    <!-- Start logging -->
    <mkdir dir="${log.dir}" />
    <tstamp>
        <format property="install.time" pattern="yyyy-MM-dd-HH-mm" />
    </tstamp>
    <record name="${log.dir}/install-${install.time}.log" action="start"/>


    <!-- Installer section -->
    <target name="diag">
        <echoproperties/>
    </target>

    <!-- Clean up destination directory -->
    <target name="install:clean" description="Removes all files from the local filesystem" depends="install:clean:jboss">
    </target>

    <target name="install:clean:jboss" unless="exclude.jboss">
        <sleep seconds="5" />
        <property name="backup.count" value="5"/>

        <if>
            <not>
                <equals arg1="${exclude.jboss.backup}" arg2="true"/>
            </not>
            <then>
                <!-- Jboss backup, do not compress until install is finished -->
                <property name="backup.jboss.base.dir" location="${application.base.path}/backup/jboss"/>

                <!-- So these directories won't be included in the backup, they are not needed to use jboss -->
                <delete dir="${jboss.home}/server/${jboss.server.name}/work"/>
                <delete dir="${jboss.home}/server/${jboss.server.name}/tmp"/>
                <delete dir="${jboss.home}/server/${pagrid.jboss.server.name}/work"/>
                <delete dir="${jboss.home}/server/${pagrid.jboss.server.name}/tmp"/>

                <backup-dir
                    src.dir="${jboss.home}"
                    backup.base.dir="${backup.jboss.base.dir}"
                    backup.count="${backup.count}"
                    />
            </then>
        </if>
        <delete dir="${jboss.home}"/>
    </target>

    <!-- Does directory management and copy some files with filtering to ensure token expansion -->
    <target name="install:init" description="Does directory management to initialize install">
        <mkdir dir="${working.dir}" />
        <delete dir="${working.dir}"/>
        <mkdir dir="${working.dir}" />
        <mkdir dir="${resource.dir.temp}"/>
        <!-- Copy files to ensure values containing variables are expanded, such properties are stored in filterset.pre and then copy with filter files -->
        <copy todir="${common.dir.dest}" filtering="true">
            <fileset dir="${common.dir.src}">
                <include name="**/*"/>
            </fileset>
            <filterset refid="filterset.pre"/>
            <filterset>
                <filtersfile file="${properties.file}"/>
                <filtersfile file="project.properties"/>
            </filterset>
        </copy>
    <property name="db.prop.list" value="database.url,database.user,database.password,database.name"/>
    <echo  message="Checking if database properties exist: ${db.prop.list}"/>
    <properties-exist properties.list="${db.prop.list}"/>
    <math result="jboss.ssl.port" operand1="${jboss.server.port}" operation="+" operand2="363" datatype="int"/>
    </target>

    <target name="install:database:prep" description="Copies db files with filtering" unless="exclude.database" depends="install:init">
        <property name="db.dir.temp" value="${working.dir}/tmp"/>
        <mkdir dir="${db.dir.temp}"/>
        <copy todir="${db.dir.dest}" filtering="true">
            <fileset dir="${db.dir.src}">
                <include name="**/*"/>
            </fileset>
            <filterset refid="filterset.pre"/>
            <filterset>
                <filtersfile file="${properties.file}"/>
                <filtersfile file="project.properties"/>
            </filterset>
        </copy>
        <if>
            <and>
                <equals arg1="${database.re-create}" arg2="true"/>
                <equals arg1="${database.drop-schema}" arg2="true"/>
            </and>
            <then>
                <fail message="You cannot set both database.re-create and database.drop-schema at the same time.  database.re-create is used in local installs.  database.drop-schema is used in remote installs.  Either one can be set for external (Cancer Center) installs."/>
            </then>
        </if>
    <mkdir dir="${os.temp.dir}/${project.name}"/>
    <copy todir="${os.temp.dir}/${project.name}" filtering="true" flatten="true" overwrite="true">
        <fileset dir="${db.dir.dest}">
            <include name="**/db-upgrade.xml"/>
        </fileset>
    </copy>
    </target>

    <target name="install:database" description="Runs datbase creation scripts then calls uprade database." unless="exclude.database"
            depends="
            install:init,
            install:database:prep
            ">
        <!-- Drop all schema objects or re-create the db -->
        <echo>preparing to run database clean</echo>
        <database-clean/>

        <!-- Run baseline scripts stored in db.install.create.${database.type}.file.list variable -->
        <switch value="${database.type}">
            <case value="postgresql">
                <database-install
                    db.install.create.file.list="${db.install.create.postgresql.file.list}"
                    sql.delimiter="/"
                    sql.delimitertype="row"/>
            </case>
        </switch>

        <database-upgrade/>
        <database-tag/>
    </target>

    <target name="install:jboss:binaries" description="Unzip JBoss binary" unless="exclude.jboss">
        <antcall target="install:jboss:binaries:pa-ear"/>
        <antcall target="install:jboss:binaries:pa-grid"/>
        <antcall target="install:jboss:binaries:pa-grid-legacy"/>
        <antcall target="install:jboss:binaries:outcomes-grid"/>
    </target>

    <macrodef name="jboss-install-binaries2" description="Added params to support different types of installations, should be pulled up into BDA-utils">
        <attribute name="application.base.path" default="${application.base.path}"/>
        <attribute name="jboss.binaries.file" default="${tools.dir}/${jboss.binaries.file}" />
        <attribute name="jboss.server.name" default="${jboss.server.name}" />
        <attribute name="jems.install.option" default="ejb3" />
        <attribute name="jboss.home" default="${jboss.home}" />
        <sequential>
            <var name="jboss.file.is.zip" unset="true"/>
            <propertyregex property="jboss.file.is.zip"
                input="@{jboss.binaries.file}"
                regexp=".*.zip"
                select="true"
                />
            <var name="jboss.file.is.jar" unset="true"/>
            <propertyregex property="jboss.file.is.jar"
                input="@{jboss.binaries.file}"
                regexp=".*.jar"
                select="true"
                />
            <if>
                <isset property="jboss.file.is.zip"/>
                <then>
                    <unzip dest="@{application.base.path}" src="@{jboss.binaries.file}" />
                </then>
            </if>
            <if>
                <isset property="jboss.file.is.jar"/>
                <then>
                    <echo message="Using -installGroup @{jems.install.option} installpath=@{jboss.home}"/>
                    <java jar="@{jboss.binaries.file}" fork="true">
                        <arg line="-installGroup @{jems.install.option} installpath=@{jboss.home}"/>
                    </java>
                </then>
            </if>

            <!-- make sure default server is renamed if applicable -->
            <if>
                <not>
                    <equals arg1="@{jboss.server.name}" arg2="default"/>
                </not>
                <then>
                    <move todir="@{jboss.home}/server/@{jboss.server.name}">
                        <fileset dir="@{jboss.home}/server/default"/>
                    </move>
                </then>
            </if>

            <if>
                <os family="unix"/>
                <then>
                    <chmod dir="@{jboss.home}/bin" perm="ugo+rx"
                        includes="**/*.sh"/>
                </then>
            </if>
        </sequential>
    </macrodef>

    <target name="install:jboss:binaries:pa-ear" unless="exclude.pa-ear">
        <jboss-install-binaries2
            jboss.server.name="${jboss.server.name}"
            />
    </target>
    <target name="install:jboss:binaries:pa-grid" unless="exclude.pa-grid">
        <jboss-install-binaries2
            jems.install.option="default"
            jboss.server.name="${pagrid.jboss.server.name}"
            />
    </target>
    <target name="install:jboss:binaries:pa-grid-legacy" unless="exclude.pa-grid-legacy">
      <jboss-install-binaries2
          jems.install.option="default"
        jboss.server.name="${pa-grid-legacy.jboss.server.name}"
              />
    </target>
    <target name="install:jboss:binaries:outcomes-grid" unless="exclude.outcomes-grid">
      <jboss-install-binaries2
          jems.install.option="default"
        jboss.server.name="${outcomes-grid.jboss.server.name}"
              />
    </target>

    <target name="install:jboss:pa-ear" description="Deploy pa-ear pa-ear.ear, pa-ear-api.war and common libraries" unless="exclude.pa-ear">
        <!-- added to ensure working.dirs are fresh for our install -->
        <delete dir="${jboss.home}/server/${jboss.server.name}/tmp" failonerror="false"/>
        <delete dir="${jboss.home}/server/${jboss.server.name}/work" failonerror="false"/>
        <move file="${jboss.home}/server/${jboss.server.name}/log/server.log" tofile="${jboss.home}/server/${jboss.server.name}/log/server.log.${install.time}" failonerror="false"/>


        <copy file="${pa-ear.dir.dist}/${pa-ear.ear.file}" todir="${jboss.home}/server/${jboss.server.name}/deploy" overwrite="true" />

        <!--  Many NCI applications require clm for csm, so you can point this to where you have the version you want to use
        <copy file="${bda-utils.dir}/clm-3.2.jar" todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true" />
        <copy file="${database.driver.file}" todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true" />j
        -->

        <!-- deploy jars to server lib but remove old ones first -->
        <delete verbose="true">
            <fileset dir="${jboss.home}/server/${jboss.server.name}/lib" includesfile="jboss-server-lib-deletes.txt" />
        </delete>
        <copy todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true">
            <fileset dir="${pa-container-jar.dist.dir}"/>
        </copy>
    </target>

    <!-- The emptySessionPath must be false to avoid Session Fixation Appscan issues and be compatible with the
        security-config.xml login-module definitions. This is duplicated in the accrual/build.xml to support developer
        deployments. This definition supports the remote deployment and full installation.
    -->
    <target name="find-server-xml" unless="exclude.accrual-ear">
        <available file="${jboss.home}/server/${jboss.server.name}/deploy/jbossweb-tomcat55.sar/server.xml" property="server-xml.present"/>
    </target>
    <target name="fix-server-xml" depends="find-server-xml" if="server-xml.present">
        <copy file="${jboss.home}/server/${jboss.server.name}/deploy/jbossweb-tomcat55.sar/server.xml" todir="${pa-ear.dir.dist}" overwrite="true"/>
        <copy file="${pa-ear.dir.dist}/server.xml" todir="${jboss.home}/server/${jboss.server.name}/deploy/jbossweb-tomcat55.sar" overwrite="true">
            <filterchain>
                <tokenfilter>
                    <replacestring from="emptySessionPath=&quot;true&quot;" to="emptySessionPath=&quot;false&quot;"/>
                </tokenfilter>
            </filterchain>
        </copy>
    </target>

    <target name="install:jboss:accrual-ear" depends="fix-server-xml" unless="exclude.accrual-ear">
        <!-- added to ensure working.dirs are fresh for our install -->
        <delete dir="${jboss.home}/server/${jboss.server.name}/tmp" failonerror="false"/>
        <delete dir="${jboss.home}/server/${jboss.server.name}/work" failonerror="false"/>
        <move file="${jboss.home}/server/${jboss.server.name}/log/server.log" tofile="${jboss.home}/server/${jboss.server.name}/log/server.log.${install.time}" failonerror="false"/>


        <copy file="${pa-ear.dir.dist}/${accrual-ear.ear.file}" todir="${jboss.home}/server/${jboss.server.name}/deploy" overwrite="true" />

        <!--  Many NCI applications require clm for csm, so you can point this to where you have the version you want to use
        <copy file="${bda-utils.dir}/clm-3.2.jar" todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true" />
        <copy file="${database.driver.file}" todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true" />j
        -->

        <!-- deploy jars to server lib -->
        <copy todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true">
            <fileset dir="${pa-container-jar.dist.dir}"/>
        </copy>
    </target>

    <target name="install:jboss:pa-ear:configure" description="Configure pa-ear application" unless="exclude.pa-ear">
        <copy file="${jboss-conf.dir.dest}/${pa-ear.ds.file}" todir="${jboss.home}/server/${jboss.server.name}/deploy" overwrite="true" />
    </target>


    <target name="install:jboss:pa-grid:pre-configure" unless="exclude.pa-grid">
        <mkdir dir="${temp.dir}/${pa-grid.dist.relative.dir}"/>
        <delete dir="${temp.dir}/${pa-grid.dist.relative.dir}"/>
        <mkdir dir="${temp.dir}/${pa-grid.dist.relative.dir}"/>
        <unzip src="${pa-grid.dir.dist}/${pa-grid.artifact.file}" dest="${temp.dir}/${pa-grid.dist.relative.dir}"/>
        <unzip src="${temp.dir}/${pa-grid.dist.relative.dir}/WEB-INF/lib/${pa-grid.introduce.skeleton.service.name}-common.jar" dest="${temp.dir}/${pa-grid.introduce.skeleton.service.name}-common"/>
        <!-- Filter contents of the files below to be based on install time properties. Paths below are paths witin the ear. -->
        <var name="file.list"
            value="${pa-grid.introduce.skeleton.service.name}-common/jndi.properties"/>

        <for list="${file.list}" param="file.relative.name">
            <sequential>
                <propertyregex property="file.name"
                    input="@{file.relative.name}"
                    regexp="^.*\/(.*)"
                    select="\1"
                    override="true"
                    />
                <propertyregex property="relative.dir"
                    input="@{file.relative.name}"
                    regexp="^(.*)\/.*"
                    select="\1"
                    override="true"
                    />
                <echo message="relative.dir=${relative.dir} file.name=${file.name}"/>
                <replace file="${temp.dir}/${relative.dir}/${file.name}" token="%%" value="@"/>
                <copy todir="${temp.dir}" file="${temp.dir}/${relative.dir}/${file.name}" filtering="true" overwrite="true">
                    <filterset>
                        <filter token="jboss.server.jndi.port" value="${jboss.server.jndi.port}"/>
                        <filter token="pagrid.jndi.principal" value="${pagrid.jndi.principal}"/>
                        <filter token="pagrid.jndi.credentials" value="${pagrid.jndi.credentials}"/>
                    </filterset>
                </copy>
                <copy todir="${temp.dir}/${relative.dir}" file="${temp.dir}/${file.name}" overwrite="true"/>
            </sequential>
        </for>
        <move file="${pa-grid.dir.dist}/${pa-grid.artifact.file}" tofile="${pa-grid.dir.dist}/${pa-grid.artifact.file}.orig"/>
        <jar destfile="${temp.dir}/${pa-grid.dist.relative.dir}/WEB-INF/lib/${pa-grid.introduce.skeleton.service.name}-common.jar"
                    basedir="${temp.dir}/${pa-grid.introduce.skeleton.service.name}-common" compress="false"/>

        <zip basedir="${temp.dir}/${pa-grid.dist.relative.dir}" compress="true" file="${pa-grid.dir.dist}/${pa-grid.artifact.file}" update="false"/>
    </target>

    <target name="install:jboss:outcomes-grid:pre-configure" unless="exclude.outcomes-grid">
        <mkdir dir="${temp.dir}/${outcomes-grid.dist.relative.dir}"/>
        <delete dir="${temp.dir}/${outcomes-grid.dist.relative.dir}"/>
        <mkdir dir="${temp.dir}/${outcomes-grid.dist.relative.dir}"/>
        <unzip src="${outcomes-grid.dir.dist}/${outcomes-grid.artifact.file}" dest="${temp.dir}/${outcomes-grid.dist.relative.dir}"/>
        <unzip src="${temp.dir}/${outcomes-grid.dist.relative.dir}/WEB-INF/lib/${outcomes-grid.introduce.skeleton.service.name}-common.jar" dest="${temp.dir}/${outcomes-grid.introduce.skeleton.service.name}-common"/>
        <!-- Filter contents of the files below to be based on install time properties. Paths below are paths witin the ear. -->
        <var name="file.list"
            value="${outcomes-grid.introduce.skeleton.service.name}-common/jndi.properties"/>

        <for list="${file.list}" param="file.relative.name">
            <sequential>
                <propertyregex property="file.name"
                    input="@{file.relative.name}"
                    regexp="^.*\/(.*)"
                    select="\1"
                    override="true"
                    />
                <propertyregex property="relative.dir"
                    input="@{file.relative.name}"
                    regexp="^(.*)\/.*"
                    select="\1"
                    override="true"
                    />
                <echo message="relative.dir=${relative.dir} file.name=${file.name}"/>
                <replace file="${temp.dir}/${relative.dir}/${file.name}" token="%%" value="@"/>
                <copy todir="${temp.dir}" file="${temp.dir}/${relative.dir}/${file.name}" filtering="true" overwrite="true">
                    <filterset>
                        <filter token="jboss.server.jndi.port" value="${jboss.server.jndi.port}"/>
                        <filter token="outcomes-grid.jndi.principal" value="${outcomes-grid.jndi.principal}"/>
                        <filter token="outcomes-grid.jndi.credentials" value="${outcomes-grid.jndi.credentials}"/>
                    </filterset>
                </copy>
                <copy todir="${temp.dir}/${relative.dir}" file="${temp.dir}/${file.name}" overwrite="true"/>
            </sequential>
        </for>
        <move file="${outcomes-grid.dir.dist}/${outcomes-grid.artifact.file}" tofile="${outcomes-grid.dir.dist}/${outcomes-grid.artifact.file}.orig"/>
        <jar destfile="${temp.dir}/${outcomes-grid.dist.relative.dir}/WEB-INF/lib/${outcomes-grid.introduce.skeleton.service.name}-common.jar"
                    basedir="${temp.dir}/${outcomes-grid.introduce.skeleton.service.name}-common" compress="false"/>

        <zip basedir="${temp.dir}/${outcomes-grid.dist.relative.dir}" compress="true" file="${outcomes-grid.dir.dist}/${outcomes-grid.artifact.file}" update="false"/>
    </target>

    <!-- Installs the pa-grid application to JBOSS -->
    <target name="install:pa-grid:application" description="Deploy Coppa PO Grid application to JBOSS" unless="exclude.pa-grid">
        <echo message="Entirely removing existing wsrf.war deployment"/>
        <delete dir="${jboss.home}/server/${pagrid.jboss.server.name}/deploy/${pa-grid.dir.target}"/>
        <mkdir dir="${jboss.home}/server/${pagrid.jboss.server.name}/deploy/${pa-grid.dir.target}"/>

        <unzip dest="${jboss.home}/server/${pagrid.jboss.server.name}/lib" src="${grid.resource.dir.src}/${resource.file.jboss-globus-lib}" />
        <unzip dest="${jboss.home}/server/${pagrid.jboss.server.name}/deploy/${pa-grid.dir.target}" src="${grid.resource.dir.src}/${resource.file.jboss-globus-war}" />

        <unzip dest="${jboss.home}/server/${pagrid.jboss.server.name}/deploy/${pa-grid.dir.target}" src="${pa-grid.dir.src}/${pa-grid.artifact.file}" />
    </target>
    <!-- Installs the pa-grid-legacy application to JBOSS -->
    <target name="install:pa-grid-legacy:application" description="Deploy Coppa PA Grid Legacy application to JBOSS" unless="exclude.pa-grid-legacy">
      <echo message="Entirely removing existing wsrf.war deployment"/>
      <delete dir="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/deploy/${pa-grid-legacy.dir.target}"/>
        <mkdir dir="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/deploy/${pa-grid-legacy.dir.target}"/>

        <unzip dest="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/lib" src="${grid.resource.dir.src}/${resource.file.jboss-globus-lib}" />
        <unzip dest="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/deploy/${pa-grid-legacy.dir.target}" src="${grid.resource.dir.src}/${resource.file.jboss-globus-war}" />

        <unzip dest="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/deploy/${pa-grid-legacy.dir.target}" src="${pa-grid-legacy.dir.src}/${pa-grid-legacy.artifact.file}" />
    </target>
    <!-- Installs the outcomes-grid application to JBOSS -->
    <target name="install:outcomes-grid:application" description="Deploy Coppa Outcomes Grid application to JBOSS" unless="exclude.outcomes-grid">
        <echo message="Entirely removing existing wsrf.war deployment"/>
        <delete dir="${jboss.home}/server/${outcomes-grid.jboss.server.name}/deploy/${outcomes-grid.dir.target}"/>
        <mkdir dir="${jboss.home}/server/${outcomes-grid.jboss.server.name}/deploy/${outcomes-grid.dir.target}"/>

        <unzip dest="${jboss.home}/server/${outcomes-grid.jboss.server.name}/lib" src="${grid.resource.dir.src}/${resource.file.jboss-globus-lib}" />
        <unzip dest="${jboss.home}/server/${outcomes-grid.jboss.server.name}/deploy/${outcomes-grid.dir.target}" src="${grid.resource.dir.src}/${resource.file.jboss-globus-war}" />

        <unzip dest="${jboss.home}/server/${outcomes-grid.jboss.server.name}/deploy/${outcomes-grid.dir.target}" src="${outcomes-grid.dir.src}/${outcomes-grid.artifact.file}" />
    </target>

    <!-- Configures installed pa-grid application -->
    <target name="install:pa-grid:configure" description="Configure pa-grid service based on properties" unless="exclude.pa-grid">
        <!--
        NOTE: During an upgrade, the <jboss-configure/> macrodef (which calls <grid-secure-configure-connector/> macrodef) copies over
        the -cert.pem and -key.pem host cert file to the ${jboss.home}/server/${pagrid.jboss.server.name}/conf directory.
        Therefore, we're changing the appserver.conf.dir property to point to pagrid.grid.secure.dir instead.

        This is required whenever the host certs are not installed within the ${jboss.home}/server/${pagrid.jboss.server.name}/conf directory
        -->
        <grid-appserver-configure
            appserver.home="${jboss.home}"
            appserver.server.name="${pagrid.jboss.server.name}"
            appserver.conf.dir="${pagrid.grid.secure.dir}"
            appserver.webapp.dir="${jboss.home}/server/${pagrid.jboss.server.name}/deploy"
            appserver.server-xml.file="${jboss.home}/server/${pagrid.jboss.server.name}/deploy/jbossweb-tomcat55.sar/server.xml"
            appserver.server-xml.service.name="jboss.web"
            appserver.port.http="${pagrid.jboss.server.port}"
            appserver.port.ssl=""
            appserver.hostname="${jboss.server.hostname}"
            search.host="localhost"
            search.port="8080"
            grid.application.name="${pa-grid.introduce.skeleton.service.name}"
            grid.application.relative.dir="${pa-grid.dir.target}"
            grid.secure.dir="${pagrid.grid.secure.dir}"
            grid.secure.enable="${pagrid.grid.secure.enable}"
            grid.secure.port="${pagrid.grid.secure.port}"
            grid.secure.key.file="${pagrid.grid.secure.key.file}"
            grid.secure.cert.file="${pagrid.grid.secure.cert.file}"
            grid.external.secure.host="${pagrid.grid.external.secure.host}"
            grid.external.secure.port="${pagrid.grid.external.secure.port}"
            appserver.external.http.host="${pagrid.jboss.external.http.host}"
        />
    </target>

    <!-- Configures installed pa-grid application -->
    <target name="install:pa-grid-legacy:configure" description="Configure pa-grid-legacy service based on properties" unless="exclude.pa-grid-legacy">
        <grid-appserver-configure
          appserver.conf.dir="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/conf"
          appserver.webapp.dir="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/deploy"
          appserver.server-xml.file="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/deploy/jbossweb-tomcat55.sar/server.xml"
          appserver.server-xml.service.name="jboss.web"
          appserver.port.http="${pa-grid-legacy.jboss.server.port}"
          appserver.port.ssl=""
          appserver.hostname="${jboss.server.hostname}"
          search.host="localhost"
          search.port="8080"
          grid.application.name="${pa-grid-legacy.introduce.skeleton.service.name}"
          grid.application.relative.dir="${pa-grid-legacy.dir.target}"
          grid.secure.enable="false"
          appserver.external.http.host="${pa-grid-legacy.jboss.external.http.host}"
        />
    </target>
    <!-- Configures installed outcomes-grid application -->
    <target name="install:outcomes-grid:configure" description="Configure outcomes-grid service based on properties" unless="exclude.outcomes-grid">
        <!--
        NOTE: During an upgrade, the <jboss-configure/> macrodef (which calls <grid-secure-configure-connector/> macrodef) copies over
        the -cert.pem and -key.pem host cert file to the ${jboss.home}/server/${outcomes-grid.jboss.server.name}/conf directory.
        Therefore, we're changing the appserver.conf.dir property to point to outcomes-grid.grid.secure.dir instead.

        This is required whenever the host certs are not installed within the ${jboss.home}/server/${outcomes-grid.jboss.server.name}/conf directory
        -->
        <grid-appserver-configure
            appserver.home="${jboss.home}"
            appserver.server.name="${outcomes-grid.jboss.server.name}"
            appserver.conf.dir="${outcomes-grid.grid.secure.dir}"
            appserver.webapp.dir="${jboss.home}/server/${outcomes-grid.jboss.server.name}/deploy"
            appserver.server-xml.file="${jboss.home}/server/${outcomes-grid.jboss.server.name}/deploy/jbossweb-tomcat55.sar/server.xml"
            appserver.server-xml.service.name="jboss.web"
            appserver.port.http="${outcomes-grid.jboss.server.port}"
            appserver.port.ssl=""
            appserver.hostname="${jboss.server.hostname}"
            search.host="localhost"
            search.port="8080"
            grid.application.name="${outcomes-grid.introduce.skeleton.service.name}"
            grid.application.relative.dir="${outcomes-grid.dir.target}"
            grid.secure.dir="${outcomes-grid.grid.secure.dir}"
            grid.secure.enable="${outcomes-grid.grid.secure.enable}"
            grid.secure.port="${outcomes-grid.grid.secure.port}"
            grid.secure.key.file="${outcomes-grid.grid.secure.key.file}"
            grid.secure.cert.file="${outcomes-grid.grid.secure.cert.file}"
            grid.external.secure.host="${outcomes-grid.grid.external.secure.host}"
            grid.external.secure.port="${outcomes-grid.grid.external.secure.port}"
            appserver.external.http.host="${outcomes-grid.jboss.external.http.host}"
        />
    </target>

    <target name="install:jboss:configure:log4j" description="Configure custom entries in system wide log4j" unless="exclude.pa-ear" >
        <echo message="Configuring Log4J"/>
        <copy file="${jboss.home}/server/${jboss.server.name}/conf/log4j.xml" tofile="${jboss.home}/server/${jboss.server.name}/conf/log4j.xml.pre"/>

        <replaceregexp file="${jboss.home}/server/${jboss.server.name}/conf/log4j.xml"
            byline="true"
            match="^(&lt;!DOCTYPE.*)"
            replace="&lt;!-- \1 --&gt;"
            />
        <!--<copy file="${jboss.home}/server/${jboss.server.name}/conf/log4j.xml" tofile="${jboss.home}/server/${jboss.server.name}/conf/log4j.xml.1"/>-->
        <xmltask source="${jboss.home}/server/${jboss.server.name}/conf/log4j.xml"
            dest="${jboss.home}/server/${jboss.server.name}/conf/log4j.xml">
            <xmlcatalog refid="installer.catalog"/>
            <remove path="/log4j:configuration/appender[@name='TestAppender']"/>
            <insert path="/log4j:configuration">
                <![CDATA[
                <appender name="TestAppender" class="org.jboss.logging.appender.RollingFileAppender">
                    <errorHandler class="org.jboss.logging.util.OnlyOnceErrorHandler"/>
                    <param name="File" value="${jboss.server.log.dir}/testAppender.log"/>
                    <param name="Append" value="false"/>
                    <param name="MaxFileSize" value="${log4j.maxFileSize}"/>
                    <!--<param name="MaxBackupIndex" value="${log4j.maxDays}"/>-->

                    <layout class="org.apache.log4j.PatternLayout">
                        <param name="ConversionPattern" value="%d %-5p [%c] %m%n"/>
                    </layout>
                </appender>
                ]]>
            </insert>
            <remove path="/log4j:configuration/category[@name='org.nih.nci']"/>
            <insert path="/log4j:configuration">
                <![CDATA[
                <category name="org.nih.nci">
                    <priority value="${log4j.level}"/>
                </category>
                ]]>
            </insert>
            <xmlcatalog refid="bda.xml.catalog"/>
        </xmltask>
        <validate-log4j
            />

        <replaceregexp file="${jboss.home}/server/${jboss.server.name}/conf/log4j.xml"
            byline="true"
            match="^&lt;!-- (&lt;!DOCTYPE.*) --&gt;"
            replace="\1"
            />
    </target>

    <!-- Wrapper target to configure jboss container, not deployed application -->
    <target name="install:jboss:configure" description="Configure pa-ear" unless="exclude.jboss" >
        <runtarget target="install:jboss:configure:pa-ear"/>
        <runtarget target="install:jboss:configure:pa-grid"/>
        <runtarget target="install:jboss:configure:pa-grid-legacy"/>
        <runtarget target="install:jboss:configure:outcomes-grid"/>
    </target>
    <target name="install:jboss:configure:pa-ear" unless="exclude.pa-ear">
        <runtarget target="install:jboss:configure:log4j"/>
        <!-- Calls the following macros
        jboss-bindings - configures ports for jboss
        jboss-login-config - sets up authentication
        secure-jboss-console - adds password to jboss console apps
        jboss-update-shutdown - updates shutdown.jar with correct jndi port so no args need to used 4 shutdown
        appserver-ssl-configure -  enables ssl
        appserver-configure-external-hostname - configures jboss for use through a reverse proxy
        grid-secure-configure-connector - configures secure grid
        -->
        <!-- Use below if you are defining all the ports in your install.xml not the NCICB port configuraitons-->
        <jboss-configure
            jboss.server.ports.name="bda-ports"
            jboss.server.binding.template.location="${bda-utils.resource.dir}/template-binding.xml"

                />
        <!-- Default values for all attributes if you are using standard NCICB port configurations
        <jboss-configure
            />
        -->
    </target>
    <target name="install:jboss:configure:pa-grid" unless="exclude.pa-grid">
          <!-- create a new template bindings file from template (using ports for pa-grid -->
            <copy file="${bda-utils.resource.dir}/template-binding.xml"
                tofile="${bda-utils.resource.dir}/template-binding2.xml"
                filtering="true"
                overwrite="true">
                <filterset begintoken="@" endtoken="@">
                    <filter token="jboss.server.port" value="@pagrid.grid.secure.port@"/>
                    <filter token="jboss.ejbinvoker.port" value="@pagrid.jboss.ejbinvoker.port@"/>
                    <filter token="jboss.server.rmi.port" value="@jboss.grid.server.rmi.port@"/>
                    <filter token="jboss.server.jndi.port" value="@pagrid.jboss.server.jndi.port@"/>
                    <filter token="jboss.cobraorb.port" value="@pagrid.jboss.cobraorb.port@"/>
                    <filter token="jboss.ejbinvoker.port" value="@pagrid.jboss.ejbinvoker.port@"/>
                    <filter token="jboss.hajndi.port" value="@pagrid.jboss.hajndi.port@"/>
                    <filter token="jboss.hajrmi.port" value="@pagrid.jboss.hajrmi.port@"/>
                    <filter token="jboss.jms.port" value="@pagrid.jboss.jms.port@"/>
                    <filter token="jboss.jmx-rmi.port" value="@pagrid.jboss.jmx-rmi.port@"/>
                    <filter token="jboss.messaging.port" value="@pagrid.jboss.messaging.port@"/>
                    <filter token="jboss.pooledha.port" value="@pagrid.jboss.pooledha.port@"/>
                    <filter token="jboss.remoting.port" value="@jboss.grid.remoting.port@"/>
                    <filter token="jboss.server.bind.port" value="@pagrid.jboss.server.bind.port@"/>
                    <filter token="jboss.server.rmi.port" value="@jboss.grid.server.rmi.port@"/>
                    <filter token="jboss.service.rmiobject.port" value="@pagrid.jboss.service.rmiobject.port@"/>
                    <filter token="jboss.snmp.port" value="@pagrid.jboss.snmp.port@"/>
                    <filter token="jboss.snmp-trapd.port" value="@jboss.grid.snmp-trapd.port@"/>
                    <filter token="jboss.web.service.port" value="@jboss.grid.web.service.port@"/>
                </filterset>
            </copy>

           <!-- configure the pa-grid instance -->
            <jboss-configure
                jboss.home="${jboss.home}"
                jboss.server.name="${pagrid.jboss.server.name}"
                jboss.server.ports.name="bda-ports"
                jboss.server.bindingfile.location="${jboss.home}/server/${pagrid.jboss.server.name}/conf/bindings.xml"
                jboss.server.binding.template.location="${bda-utils.resource.dir}/template-binding2.xml"
                jboss.server.service.template.location="${bda-utils.resource.dir}/template-jboss-service.xml"
                authentication.type="${authentication.type}"
                login-config.ldap.file="${jboss-conf.dir.dest}/login-config.ldap-block.xml"
                login-config.db.file="${jboss-conf.dir.dest}/login-config.db-block.xml"
                jboss.web.user="${jboss.web.user}"
                jboss.web.password="${jboss.web.password}"
                jboss.server.jndi.port="${pagrid.jboss.server.jndi.port}"
                jboss.conf.dir="${jboss.home}/server/${pagrid.jboss.server.name}/conf"
                jboss.server-xml.file="${jboss.home}/server/${pagrid.jboss.server.name}/deploy/jbossweb-tomcat55.sar/server.xml"
                jboss.server-xml.service.name="jboss.web"
                jboss.ssl.enable="false"
                jboss.ssl.port="8443"
                jboss.ssl.keystore.file="${jboss.ssl.keystore.file}"
                jboss.ssl.keystore.dir="${jboss.ssl.keystore.dir}"
                jboss.ssl.keystore.pass="${jboss.ssl.keystore.pass}"
                jboss.ssl.keystore.alias="${jboss.ssl.keystore.alias}"
                jboss.ssl.fullyqualified.hostname="${jboss.ssl.fullyqualified.hostname}"
                jboss.external.ssl.host="${jboss.external.ssl.host}"
                jboss.external.ssl.port="${jboss.external.ssl.port}"
                proxy.update.connector.port.ssl="8443"
                jboss.external.http.host="${pagrid.jboss.external.http.host}"
                jboss.external.http.port="${pagrid.jboss.external.http.port}"
                proxy.update.connector.port.http="8080"
                grid.external.secure.host="${pagrid.grid.external.secure.host}"
                grid.external.secure.port="${pagrid.grid.external.secure.port}"
                jboss.server.hostname="${jboss.server.hostname}"
                jboss.grid.configure="true"
                grid.secure.dir="${pagrid.grid.secure.dir}"
                grid.secure.enable="${pagrid.grid.secure.enable}"
                grid.secure.port="${pagrid.grid.secure.port}"
                grid.secure.key.file="${pagrid.grid.secure.key.file}"
                grid.secure.cert.file="${pagrid.grid.secure.cert.file}"
                jboss.java.opts="${jboss.java.opts}"
                jboss.http-connector.remove="true"
                />
    </target>


    <target name="install:jboss:configure:pa-grid-legacy" unless="exclude.pa-grid-legacy">
          <!-- create a new template bindings file from template (using ports for pa-grid -->
            <copy file="${bda-utils.resource.dir}/template-binding.xml"
                tofile="${bda-utils.resource.dir}/template-binding3.xml"
                filtering="true"
                overwrite="true">
                <filterset begintoken="@" endtoken="@">
                    <filter token="jboss.server.port" value="@pa-grid-legacy.jboss.server.port@"/>
                    <filter token="jboss.ejbinvoker.port" value="@pa-grid-legacy.jboss.ejbinvoker.port@"/>
                    <filter token="jboss.server.rmi.port" value="@pa-grid-legacy.jboss.server.rmi.port@"/>
                    <filter token="jboss.server.jndi.port" value="@pa-grid-legacy.jboss.server.jndi.port@"/>
                    <filter token="jboss.cobraorb.port" value="@pa-grid-legacy.jboss.cobraorb.port@"/>
                    <filter token="jboss.ejbinvoker.port" value="@pa-grid-legacy.jboss.ejbinvoker.port@"/>
                    <filter token="jboss.hajndi.port" value="@pa-grid-legacy.jboss.hajndi.port@"/>
                    <filter token="jboss.hajrmi.port" value="@pa-grid-legacy.jboss.hajrmi.port@"/>
                    <filter token="jboss.jms.port" value="@pa-grid-legacy.jboss.jms.port@"/>
                    <filter token="jboss.jmx-rmi.port" value="@pa-grid-legacy.jboss.jmx-rmi.port@"/>
                    <filter token="jboss.messaging.port" value="@pa-grid-legacy.jboss.messaging.port@"/>
                    <filter token="jboss.pooledha.port" value="@pa-grid-legacy.jboss.pooledha.port@"/>
                    <filter token="jboss.remoting.port" value="@pa-grid-legacy.jboss.remoting.port@"/>
                    <filter token="jboss.server.bind.port" value="@pa-grid-legacy.jboss.server.bind.port@"/>
                    <filter token="jboss.server.rmi.port" value="@pa-grid-legacy.jboss.server.rmi.port@"/>
                    <filter token="jboss.service.rmiobject.port" value="@pa-grid-legacy.jboss.service.rmiobject.port@"/>
                    <filter token="jboss.snmp.port" value="@pa-grid-legacy.jboss.snmp.port@"/>
                    <filter token="jboss.snmp-trapd.port" value="@pa-grid-legacy.jboss.snmp-trapd.port@"/>
                    <filter token="jboss.web.service.port" value="@pa-grid-legacy.jboss.web.service.port@"/>
                </filterset>
            </copy>

           <!-- configure the pa-grid instance -->
            <jboss-configure
                jboss.home="${jboss.home}"
                jboss.server.name="${pa-grid-legacy.jboss.server.name}"
                jboss.server.ports.name="bda-ports"
                jboss.server.bindingfile.location="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/conf/bindings.xml"
                jboss.server.binding.template.location="${bda-utils.resource.dir}/template-binding3.xml"
                jboss.server.service.template.location="${bda-utils.resource.dir}/template-jboss-service.xml"
                authentication.type="${authentication.type}"
                login-config.ldap.file="${jboss-conf.dir.dest}/login-config.ldap-block.xml"
                login-config.db.file="${jboss-conf.dir.dest}/login-config.db-block.xml"
                jboss.web.user="${jboss.web.user}"
                jboss.web.password="${jboss.web.password}"
                jboss.server.jndi.port="${pa-grid-legacy.jboss.server.jndi.port}"
                jboss.conf.dir="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/conf"
                jboss.server-xml.file="${jboss.home}/server/${pa-grid-legacy.jboss.server.name}/deploy/jbossweb-tomcat55.sar/server.xml"
                jboss.server-xml.service.name="jboss.web"
                jboss.ssl.enable="${jboss.ssl.enable}"
                jboss.ssl.port="8443"
                jboss.ssl.keystore.file="${jboss.ssl.keystore.file}"
                jboss.ssl.keystore.dir="${jboss.ssl.keystore.dir}"
                jboss.ssl.keystore.pass="${jboss.ssl.keystore.pass}"
                jboss.ssl.keystore.alias="${jboss.ssl.keystore.alias}"
                jboss.ssl.fullyqualified.hostname="${jboss.ssl.fullyqualified.hostname}"
                jboss.external.ssl.host="${jboss.external.ssl.host}"
                jboss.external.ssl.port="${jboss.external.ssl.port}"
                proxy.update.connector.port.ssl="8443"
                jboss.external.http.host="${pa-grid-legacy.jboss.external.http.host}"
                jboss.external.http.port="${pa-grid-legacy.jboss.external.http.port}"
                proxy.update.connector.port.http="8080"
                grid.external.secure.host="${grid.external.secure.host}"
                grid.external.secure.port="${grid.external.secure.port}"
                jboss.server.hostname="${jboss.server.hostname}"
                jboss.grid.configure="false"
                grid.secure.dir="${grid.secure.dir}"
                grid.secure.enable="${grid.secure.enable}"
                grid.secure.port="${grid.secure.port}"
                grid.secure.key.file="${grid.secure.key.file}"
                grid.secure.cert.file="${grid.secure.cert.file}"
                jboss.java.opts="${jboss.java.opts}"
                jboss.http-connector.remove="false"
                />
    </target>

    <target name="install:jboss:configure:outcomes-grid" unless="exclude.outcomes-grid">
          <!-- create a new template bindings file from template (using ports for outcomes-grid -->
            <copy file="${bda-utils.resource.dir}/template-binding.xml"
                tofile="${bda-utils.resource.dir}/template-binding4.xml"
                filtering="true"
                overwrite="true">
                <filterset begintoken="@" endtoken="@">
                    <filter token="jboss.server.port" value="@outcomes-grid.grid.secure.port@"/>
                    <filter token="jboss.ejbinvoker.port" value="@outcomes-grid.jboss.ejbinvoker.port@"/>
                    <filter token="jboss.server.rmi.port" value="@jboss.grid.server.rmi.port@"/>
                    <filter token="jboss.server.jndi.port" value="@outcomes-grid.jboss.server.jndi.port@"/>
                    <filter token="jboss.cobraorb.port" value="@outcomes-grid.jboss.cobraorb.port@"/>
                    <filter token="jboss.ejbinvoker.port" value="@outcomes-grid.jboss.ejbinvoker.port@"/>
                    <filter token="jboss.hajndi.port" value="@outcomes-grid.jboss.hajndi.port@"/>
                    <filter token="jboss.hajrmi.port" value="@outcomes-grid.jboss.hajrmi.port@"/>
                    <filter token="jboss.jms.port" value="@outcomes-grid.jboss.jms.port@"/>
                    <filter token="jboss.jmx-rmi.port" value="@outcomes-grid.jboss.jmx-rmi.port@"/>
                    <filter token="jboss.messaging.port" value="@outcomes-grid.jboss.messaging.port@"/>
                    <filter token="jboss.pooledha.port" value="@outcomes-grid.jboss.pooledha.port@"/>
                    <filter token="jboss.remoting.port" value="@jboss.grid.remoting.port@"/>
                    <filter token="jboss.server.bind.port" value="@outcomes-grid.jboss.server.bind.port@"/>
                    <filter token="jboss.server.rmi.port" value="@jboss.grid.server.rmi.port@"/>
                    <filter token="jboss.service.rmiobject.port" value="@outcomes-grid.jboss.service.rmiobject.port@"/>
                    <filter token="jboss.snmp.port" value="@outcomes-grid.jboss.snmp.port@"/>
                    <filter token="jboss.snmp-trapd.port" value="@jboss.grid.snmp-trapd.port@"/>
                    <filter token="jboss.web.service.port" value="@jboss.grid.web.service.port@"/>
                </filterset>
            </copy>

           <!-- configure the outcomes-grid instance -->
            <jboss-configure
                jboss.home="${jboss.home}"
                jboss.server.name="${outcomes-grid.jboss.server.name}"
                jboss.server.ports.name="bda-ports"
                jboss.server.bindingfile.location="${jboss.home}/server/${outcomes-grid.jboss.server.name}/conf/bindings.xml"
                jboss.server.binding.template.location="${bda-utils.resource.dir}/template-binding4.xml"
                jboss.server.service.template.location="${bda-utils.resource.dir}/template-jboss-service.xml"
                authentication.type="${authentication.type}"
                login-config.ldap.file="${jboss-conf.dir.dest}/login-config.ldap-block.xml"
                login-config.db.file="${jboss-conf.dir.dest}/login-config.db-block.xml"
                jboss.web.user="${jboss.web.user}"
                jboss.web.password="${jboss.web.password}"
                jboss.server.jndi.port="${outcomes-grid.jboss.server.jndi.port}"
                jboss.conf.dir="${jboss.home}/server/${outcomes-grid.jboss.server.name}/conf"
                jboss.server-xml.file="${jboss.home}/server/${outcomes-grid.jboss.server.name}/deploy/jbossweb-tomcat55.sar/server.xml"
                jboss.server-xml.service.name="jboss.web"
                jboss.ssl.enable="false"
                jboss.ssl.port="8443"
                jboss.ssl.keystore.file="${jboss.ssl.keystore.file}"
                jboss.ssl.keystore.dir="${jboss.ssl.keystore.dir}"
                jboss.ssl.keystore.pass="${jboss.ssl.keystore.pass}"
                jboss.ssl.keystore.alias="${jboss.ssl.keystore.alias}"
                jboss.ssl.fullyqualified.hostname="${jboss.ssl.fullyqualified.hostname}"
                jboss.external.ssl.host="${jboss.external.ssl.host}"
                jboss.external.ssl.port="${jboss.external.ssl.port}"
                proxy.update.connector.port.ssl="8443"
                jboss.external.http.host="${outcomes-grid.jboss.external.http.host}"
                jboss.external.http.port="${outcomes-grid.jboss.external.http.port}"
                proxy.update.connector.port.http="8080"
                grid.external.secure.host="${outcomes-grid.grid.external.secure.host}"
                grid.external.secure.port="${outcomes-grid.grid.external.secure.port}"
                jboss.server.hostname="${jboss.server.hostname}"
                jboss.grid.configure="true"
                grid.secure.dir="${outcomes-grid.grid.secure.dir}"
                grid.secure.enable="${outcomes-grid.grid.secure.enable}"
                grid.secure.port="${outcomes-grid.grid.secure.port}"
                grid.secure.key.file="${outcomes-grid.grid.secure.key.file}"
                grid.secure.cert.file="${outcomes-grid.grid.secure.cert.file}"
                jboss.java.opts="${jboss.java.opts}"
                jboss.http-connector.remove="true"
                />
    </target>


    <!-- Calls to bda macros for basic functionality -->
    <target name="install:jboss:stop" if="jboss.exists" unless="exclude.jboss">
        <antcall target="install:jboss:stop:outcomes-grid"/>
        <antcall target="install:jboss:stop:pa-grid-legacy"/>
        <antcall target="install:jboss:stop:pa-grid"/>
        <antcall target="install:jboss:stop:pa-ear"/>
    </target>

    <target name="install:jboss:stop:pa-ear" unless="exclude.pa-ear">
        <jboss-stop-jboss jboss.server.jndi.port="${jboss.server.jndi.port}" jboss.server.name="${jboss.server.name}"/>
    </target>
    <target name="install:jboss:stop:pa-grid" unless="exclude.pa-grid">
        <jboss-stop-jboss jboss.server.jndi.port="${pagrid.jboss.server.jndi.port}" jboss.server.name="${pagrid.jboss.server.name}"/>
    </target>
    <target name="install:jboss:stop:pa-grid-legacy" unless="exclude.pa-grid-legacy">
      <jboss-stop-jboss jboss.server.jndi.port="${pa-grid-legacy.jboss.server.jndi.port}" jboss.server.name="${pa-grid-legacy.jboss.server.name}"/>
    </target>
    <target name="install:jboss:stop:outcomes-grid" unless="exclude.outcomes-grid">
      <jboss-stop-jboss jboss.server.jndi.port="${outcomes-grid.jboss.server.jndi.port}" jboss.server.name="${outcomes-grid.jboss.server.name}"/>
    </target>

    <target name="install:jboss:start" if="jboss.exists" unless="exclude.jboss">
        <if>
            <not>
                <isset property="exclude.start.servers"/>
            </not>
            <then>
                <antcall target="install:jboss:start:pa-ear"/>
                <antcall target="install:jboss:start:pa-grid"/>
                <antcall target="install:jboss:start:pa-grid-legacy"/>
                <antcall target="install:jboss:start:outcomes-grid"/>
                <sleep seconds="15"/>
            </then>
        </if>
    </target>

    <!--
        Needed b/c Windows support in bda-utils lacks ".. -c @{jboss.server.name}"
    -->
    <macrodef name="jboss-start-jboss2" description="Starts a local JBoss instance">
        <attribute name="jboss.home" default="${jboss.home}" />
        <attribute name="jboss.server.name" default="${jboss.server.name}" />
        <sequential>
            <available file="@{jboss.home}/server/@{jboss.server.name}/bin" property="jboss.bin.exists"/>
            <if>
                <isset property="jboss.bin.exists"/>
                <then>
                    <echo message="Starting JBoss instance (@{jboss.server.name}) at @{jboss.home} with start_jboss" />
                    <exec executable="@{jboss.home}/server/@{jboss.server.name}/bin/start_jboss" osfamily="unix" />
                </then>
                <else>
                    <echo message="Starting JBoss instance (@{jboss.server.name}) at @{jboss.home} with run.sh" />
                    <exec osfamily="unix" executable="chmod" spawn="true">
                        <arg value="+x" />
                        <arg file="@{jboss.home}/bin/run.sh" />
                        <arg file="@{jboss.home}/bin/shutdown.sh" />
                    </exec>

                    <exec executable="sh" osfamily="unix" dir="@{jboss.home}/bin" spawn="true">
                        <env key="NOPAUSE" value="true" />
                        <arg line="run.sh -c @{jboss.server.name}" />
                    </exec>

                    <exec osfamily="windows" executable="${bda-utils.dir}/resource/psexec.exe" dir="@{jboss.home}/bin" spawn="true" >
                        <env key="NOPAUSE" value="true" />
                        <arg line="-d -i -w @{jboss.home}/bin @{jboss.home}/bin/run.bat -c @{jboss.server.name}" />
                    </exec>
                    <sleep seconds="15" />
                </else>
            </if>
        </sequential>
    </macrodef>

    <target name="install:jboss:start:pa-ear" unless="exclude.pa-ear">
        <jboss-start-jboss2 jboss.server.name="${jboss.server.name}"/>
    </target>
    <target name="install:jboss:start:pa-grid" unless="exclude.pa-grid">
        <jboss-start-jboss2 jboss.server.name="${pagrid.jboss.server.name}"/>
    </target>
    <target name="install:jboss:start:pa-grid-legacy" unless="exclude.pa-grid-legacy">
        <jboss-start-jboss2 jboss.server.name="${pa-grid-legacy.jboss.server.name}"/>
    </target>
    <target name="install:jboss:start:outcomes-grid" unless="exclude.outcomes-grid">
        <jboss-start-jboss2 jboss.server.name="${outcomes-grid.jboss.server.name}"/>
    </target>

    <target name="install:validation:pre-install">
        <validate-pre-install
            ant.check.version="${ant.minimum.version}"
            java.check.version.major="${java.major.version}"
            java.check.version.minor="${java.minor.version}"
            database.version="${mysql.minimum.version}"
            />
    </target>
      <target name="install:validation:pre-install:ports" >
          <runtarget target="install:validation:pre-install:ports:paear"/>
          <runtarget target="install:validation:pre-install:ports:pagrid"/>
          <runtarget target="install:validation:pre-install:ports:pagrid-legacy"/>
          <runtarget target="install:validation:pre-install:ports:outcomes-grid"/>
      </target>
      <target name="install:validation:pre-install:ports:paear" unless="exclude.pa-ear">
        <validate-ports-preinstall />
      </target>
      <target name="install:validation:pre-install:ports:pagrid" unless="exclude.pa-grid">
        <validate-ports-preinstall validation.pre.port.list="${validation.pre.port.pagrid.list}" />
      </target>
    <target name="install:validation:pre-install:ports:pagrid-legacy" unless="exclude.pa-grid-legacy">
      <validate-ports-preinstall validation.pre.port.list="${pa-grid-legacy.validation.pre.port.list}" />
    </target>
    <target name="install:validation:pre-install:ports:outcomes-grid" unless="exclude.outcomes-grid">
      <validate-ports-preinstall validation.pre.port.list="${outcomes-grid.validation.pre.port.list}" />
    </target>
      <target name="install:validation:post-install">
         <runtarget target="install:validation:post-install:paear"/>
         <runtarget target="install:validation:post-install:pagrid"/>
         <runtarget target="install:validation:post-install:pagrid-legacy"/>
         <runtarget target="install:validation:post-install:outcomes-grid"/>
      </target>
      <target name="install:validation:post-install:paear" unless="exclude.pa-ear">
        <if>
          <not>
            <isset property="exclude.start.servers"/>
          </not>
          <then>
            <validate-post-install propertyfile.backup.location="${user.home}"/>
          </then>
        </if>
      </target>
      <target name="install:validation:post-install:pagrid" unless="exclude.pa-grid">
        <if>
          <not>
            <isset property="exclude.start.servers"/>
          </not>
          <then>
            <validate-post-install
                validation.post.socket.list="${validation.post.socket.pagrid.list}"
                validation.post.http.list="${validation.post.http.pagrid.list}"
                propertyfile.backup.location="${user.home}"
                jboss.server.name="${pagrid.jboss.server.name}"
                application.url="${application.pagrid.url}"
                />
          </then>
        </if>
      </target>
    <target name="install:validation:post-install:pagrid-legacy" unless="exclude.pa-grid-legacy">
      <if>
        <not>
          <isset property="exclude.start.servers"/>
        </not>
        <then>
          <validate-post-install
              validation.post.socket.list="${pa-grid-legacy.validation.post.socket.list}"
              validation.post.http.list="${pa-grid-legacy.validation.post.http.list}"
              propertyfile.backup.location="${user.home}"
              jboss.server.name="${pa-grid-legacy.jboss.server.name}"
              application.url="${pa-grid-legacy.application.url}"
              />
        </then>
      </if>
    </target>
    <target name="install:validation:post-install:outcomes-grid" unless="exclude.outcomes-grid">
      <if>
        <not>
          <isset property="exclude.start.servers"/>
        </not>
        <then>
          <validate-post-install
              validation.post.socket.list="${outcomes-grid.validation.post.socket.list}"
              validation.post.http.list="${outcomes-grid.validation.post.http.list}"
              propertyfile.backup.location="${user.home}"
              jboss.server.name="${outcomes-grid.jboss.server.name}"
              application.url="${outcomes-grid.application.url}"
              />
        </then>
      </if>
    </target>
    <!-- Wrapper target to deploy JBOSS container -->
    <target name="install:jboss" unless="exclude.jboss"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        install:validation:pre-install:ports,
        install:clean:jboss,
        install:init,
        install:jboss:binaries,
        install:jboss:accrual-ear:re-configure,
        install:jboss:accrual-ear,
        install:jboss:pa-ear:re-configure,
        install:jboss:pa-ear,
        install:jboss:pa-ear:configure,
        install:jboss:pa-grid:pre-configure,
        install:pa-grid:application,
        install:pa-grid:configure,
        install:jboss:pa-grid-legacy:pre-configure,
        install:pa-grid-legacy:application,
        install:pa-grid-legacy:configure,
        install:jboss:outcomes-grid:pre-configure,
        install:outcomes-grid:application,
        install:outcomes-grid:configure,
        install:jboss:configure,
        install:post,
        install:jboss:start
        " />

    <!-- Wrapper target to deploy all containers to one server -->
    <target name="install" description="Installs and configures JBOSS, creates database, and deploys application"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        install:validation:pre-install:ports,
        install:clean,
        install:init,
        install:database,
        install:jboss,
        install:post,
        install:jboss:start,
        install:validation:post-install
        "/>

    <!-- Fixes hibernate dialect and other configurations in code generated at build time.  This is requred because the properties/options selected at build time can be different than those used at install time. -->
    <target name="install:jboss:pa-ear:re-configure" unless="exclude.pa-ear">
        <mkdir dir="${temp.dir}/pa-ear"/>
        <delete dir="${temp.dir}/pa-ear"/>
        <mkdir dir="${temp.dir}/pa-ear"/>
        <unzip src="${pa-ear.dir.dist}/${pa-ear.ear.file}" dest="${temp.dir}/pa-ear"/>
        <unzip src="${temp.dir}/pa-ear/pa-ejb.jar" dest="${temp.dir}/pa-ejb-jar"/>

        <!--<copy todir="${temp.dir}/pa-ejb-jar/" file="${jboss-conf.dir.dest}/pa-ds.xml"/>-->
        <!--<delete file="${temp.dir}/pa-ejb-jar/pa-ds.xml"/>-->

        <delete file="${temp.dir}/pa-ear/META-INF/security-config.xml"/>
        <copy todir="${temp.dir}/pa-ear/META-INF" filtering="true">
            <fileset dir="${jboss-conf.dir.dest}">
                <include name="security-config.xml"/>
            </fileset>
            <filterset refid="filterset.pre"/>
        </copy>

        <echo message="Fixing jndi.properties"/>
        <replaceregexp file="${temp.dir}/pa-ejb-jar/jndi.properties" byline="true"
            match="^(java.naming.provider.url)=.*"
            replace="# modified by installer ${line.separator}\1=jnp://localhost:${jboss.server.jndi.port}"/>

        <move file="${pa-ear.dir.dist}/${pa-ear.ear.file}" tofile="${pa-ear.dir.dist}/${pa-ear.ear.file}.orig"/>
        <move file="${temp.dir}/pa-ear/pa-ejb.jar" tofile="${temp.dir}/pa-ejb.jar..orig"/>

        <jar jarfile="${temp.dir}/pa-ear/pa-ejb.jar"
            compress="true"
            index="false"
            basedir="${temp.dir}/pa-ejb-jar"/>

        <ear destfile="${pa-ear.dir.dist}/${pa-ear.ear.file}"
            basedir="${temp.dir}/pa-ear"
            compress="false"
            appxml="${temp.dir}/pa-ear/META-INF/application.xml"
            />
    </target>

    <!-- Fixes hibernate dialect and other configurations in code generated at build time.  This is requred because the properties/options selected at build time can be different than those used at install time. -->
    <target name="install:jboss:accrual-ear:re-configure" unless="exclude.accrual-ear">
        <mkdir dir="${temp.dir}/accrual-ear"/>
        <delete dir="${temp.dir}/accrual-ear"/>
        <mkdir dir="${temp.dir}/accrual-ear"/>
        <unzip src="${pa-ear.dir.dist}/${accrual-ear.ear.file}" dest="${temp.dir}/accrual-ear"/>

        <delete file="${temp.dir}/accrual-ear/META-INF/security-config.xml"/>
        <copy todir="${temp.dir}/accrual-ear/META-INF" filtering="true">
            <fileset dir="${jboss-conf.dir.dest}">
                <include name="security-config.xml"/>
            </fileset>
            <filterset refid="filterset.pre"/>
        </copy>

        <move file="${pa-ear.dir.dist}/${accrual-ear.ear.file}" tofile="${pa-ear.dir.dist}/${accrual-ear.ear.file}.orig"/>

        <ear destfile="${pa-ear.dir.dist}/${accrual-ear.ear.file}"
            basedir="${temp.dir}/accrual-ear"
            compress="false"
            appxml="${temp.dir}/accrual-ear/META-INF/application.xml"
            />
    </target>
    <target name="install:jboss:pa-grid-legacy:pre-configure" unless="exclude.pa-grid-legacy">
        <mkdir dir="${temp.dir}/${pa-grid-legacy.dist.relative.dir}"/>
        <delete dir="${temp.dir}/${pa-grid-legacy.dist.relative.dir}"/>
        <mkdir dir="${temp.dir}/${pa-grid-legacy.dist.relative.dir}"/>
        <unzip src="${pa-grid-legacy.dir.dist}/${pa-grid-legacy.artifact.file}" dest="${temp.dir}/${pa-grid-legacy.dist.relative.dir}"/>
        <unzip src="${temp.dir}/${pa-grid-legacy.dist.relative.dir}/WEB-INF/lib/${pa-grid-legacy.introduce.skeleton.service.name}-common.jar" dest="${temp.dir}/${pa-grid-legacy.introduce.skeleton.service.name}-common"/>
        <!-- Filter contents of the files below to be based on install time properties. Paths below are paths witin the ear. -->
        <var name="file.list" value="${pa-grid-legacy.introduce.skeleton.service.name}-common/jndi.properties"/>

        <for list="${file.list}" param="file.relative.name">
            <sequential>
                <propertyregex property="file.name"
                    input="@{file.relative.name}"
                    regexp="^.*\/(.*)"
                    select="\1"
                    override="true"
                    />
                <propertyregex property="relative.dir"
                    input="@{file.relative.name}"
                    regexp="^(.*)\/.*"
                    select="\1"
                    override="true"
                    />
                <echo message="relative.dir=${relative.dir} file.name=${file.name}"/>
                <replace file="${temp.dir}/${relative.dir}/${file.name}" token="%%" value="@"/>
                <copy todir="${temp.dir}" file="${temp.dir}/${relative.dir}/${file.name}" filtering="true" overwrite="true">
                    <filterset>
                        <filter token="jboss.server.jndi.port" value="${jboss.server.jndi.port}"/>
                        <filter token="pa-grid-legacy.jndi.principal" value="${pa-grid-legacy.jndi.principal}"/>
                        <filter token="pa-grid-legacy.jndi.credentials" value="${pa-grid-legacy.jndi.credentials}"/>
                    </filterset>
                </copy>
                <copy todir="${temp.dir}/${relative.dir}" file="${temp.dir}/${file.name}" overwrite="true"/>
            </sequential>
        </for>
        <move file="${pa-grid-legacy.dir.dist}/${pa-grid-legacy.artifact.file}" tofile="${pa-grid-legacy.dir.dist}/${pa-grid-legacy.artifact.file}.orig"/>
        <jar destfile="${temp.dir}/${pa-grid-legacy.dist.relative.dir}/WEB-INF/lib/${pa-grid-legacy.introduce.skeleton.service.name}-common.jar"
                    basedir="${temp.dir}/${pa-grid-legacy.introduce.skeleton.service.name}-common" compress="false"/>

        <zip basedir="${temp.dir}/${pa-grid-legacy.dist.relative.dir}" compress="true" file="${pa-grid-legacy.dir.dist}/${pa-grid-legacy.artifact.file}" update="false"/>
    </target>
    <!-- Wrapper target to upgrade jboss container. Does not install or configure binaries -->
    <target name="upgrade:jboss" unless="exclude.jboss"
        description="Wrapper target to call all targets required to upgrade jboss container."
        depends="
        upgrade-ncm:jboss,
        install:jboss:accrual-ear,
        install:jboss:accrual-ear:re-configure,
        install:jboss:pa-ear:re-configure,
        install:jboss:pa-ear,
        install:jboss:pa-ear:configure,
        install:jboss:pa-grid:pre-configure,
        install:pa-grid:application,
        install:pa-grid:configure,
        install:jboss:pa-grid-legacy:pre-configure,
        install:pa-grid-legacy:application,
        install:pa-grid-legacy:configure,
        install:jboss:outcomes-grid:pre-configure,
        install:outcomes-grid:application,
        install:outcomes-grid:configure,
        install:jboss:start
        " />

    <!-- Wrapper target to upgrade all container. Does not install or configure binaries -->
    <target name="upgrade" description="Upgrades JBoss and Database"
        depends="
        upgrade-ncm,
        upgrade:init,
        install:validation:pre-install,
        install:jboss:stop,
        install:init,
        upgrade:database,
        upgrade:jboss,
        install:validation:post-install
        "/>

    <!-- Wrapper upgrade database target.  Target path can be skipped by exlude.database. -->
    <target name="upgrade:database" description="Upgrades database using BDA Datbase Upgrade process." unless="exclude.database"
            depends="
            install:init,
            install:database:prep,
            upgrade:init
            ">
        <database-upgrade/>
        <database-tag/>
    </target>

    <target name="upgrade:init">
        <jboss-read-dbconfig
            jboss.ds-xml.file="${bda-blueprints-webapp.ds.file}"
            />
        <jboss-read-ldapconfig
            />
    </target>

    <target name="upgrade:database:tag" description="Tags current state of database with a tag to allow for rollback of database to previous versions." unless="exclude.database"
            depends="
            install:init,
            install:database:prep,
            upgrade:init
            ">
        <database-tag/>
    </target>

    <target name="upgrade:database:rollback" description="Rolls back database to previous tagged version using rollback scripts." unless="exclude.database"
            depends="
            install:init,
            install:database:prep,
            upgrade:init
            ">
        <database-rollback/>
    </target>

    <target name="install:post" depends="install:post:jboss">
    </target>

    <target name="install:post:jboss" unless="exclude.jboss">
        <if>
            <not>
                <equals arg1="${exclude.jboss.backup}" arg2="true"/>
            </not>
            <then>
                <property name="changelogFile" location="${install-logs.dir}/chagneLog-${install.time}.txt"/>
                <property name="compare1.dir" location="${backup.jboss.base.dir}/backup/${jboss.relative.path}"/>
                <property name="compare2.dir" location="${jboss.home}"/>
                <report-dir-diff
                    dir1="${compare1.dir}"
                    dir2="${compare2.dir}"
                    reportFile="${changelogFile}"
                    />
                <!-- Copy app server logs -->
                <mkdir dir="${jboss.home}/server/${jboss.server.name}/log"/>
                <mkdir dir="${backup.jboss.base.dir}/backup/${jboss.relative.path}/server/${jboss.server.name}/log"/>
                <!-- so the logs wont be included in the zip -->
                <move todir="${jboss.home}/server/${jboss.server.name}/log">
                    <fileset dir="${backup.jboss.base.dir}/backup/${jboss.relative.path}/server/${jboss.server.name}/log">
                        <include name="*"/>
                    </fileset>
                </move>

                <!-- Compress backup and cleanup -->
                <mkdir dir="${backup.jboss.base.dir}/backup1"/>
                <zip destfile="${backup.jboss.base.dir}/backup1/${jboss.relative.path}.zip" basedir="${backup.jboss.base.dir}/backup" />
                <delete dir="${backup.jboss.base.dir}/backup"/>
            </then>
        </if>
    </target>

    <!-- Upgrade with Disposable Application Conttainer (DAC) -->
    <target name="upgrade-dac:jboss" description="Wrapper target to call all targets required to upgrade jboss container." unless="exclude.jboss"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        install:validation:pre-install:ports,
        install:clean:jboss,
        install:init,
        install:jboss:binaries,
        install:jboss:configure,
        install:post:jboss
        ">
    </target>

    <target name="upgrade-dac" description="Upgrades JBoss and Database"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        upgrade:init,
        install:init,
        upgrade:database,
        upgrade:jboss,
        install:validation:post-install
        ">
    </target>

    <target name="upgrade-dac:with-dbinstall" description="Upgrades JBoss and Database"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        upgrade:init,
        install:init,
        install:database,
        upgrade:jboss,
        install:validation:post-install
        ">
    </target>

    <!-- Upgrade with Container Modification (CM) -->
    <target name="upgrade-cm:jboss" description="Wrapper target to call all targets required to upgrade jboss container." unless="exclude.jboss"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        install:validation:pre-install:ports,
        install:init,
        install:jboss:configure,
        install:post:jboss
        ">
    </target>

    <target name="upgrade-cm" description="Upgrades JBoss and Database"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        upgrade:init,
        install:init,
        upgrade:database,
        upgrade:jboss,
        install:validation:post-install
        ">
    </target>

    <target name="upgrade-cm:with-dbinstall" description="Upgrades JBoss and Database"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        upgrade:init,
        install:init,
        install:database,
        upgrade:jboss,
        install:validation:post-install
        ">
    </target>

    <!-- Upgrade with No Container Modification (NCM) -->
    <target name="upgrade-ncm:jboss" description="Wrapper target to call all targets required to upgrade jboss container." unless="exclude.jboss"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        install:validation:pre-install:ports,
        install:init,
        install:post:jboss
        ">
    </target>

    <target name="upgrade-ncm" description="Upgrades JBoss and Database"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        upgrade:init,
        install:init,
        upgrade:database,
        upgrade:jboss,
        install:validation:post-install
        ">
    </target>

    <target name="upgrade-ncm:with-dbinstall" description="Upgrades JBoss and Database"
        depends="
        install:validation:pre-install,
        install:jboss:stop,
        upgrade:init,
        install:init,
        install:database,
        upgrade:jboss,
        install:validation:post-install
        ">
    </target>
</project>
