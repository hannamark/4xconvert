<?xml version="1.0" encoding="UTF-8"?>

<!-- ====================================================================== -->
<!-- Ant build file (http://ant.apache.org/) for Ant 1.6.2 or above.        -->
<!-- ====================================================================== -->

<project name="pa-ear" default="test-all" basedir=".">
    <property file="${basedir}/../build.properties"/>
	
    <property name="pa-ear.lib.dir" value="${basedir}/../lib"/>
    <property name="pa-ear.lib.test.dir" value="${pa-ear.lib.dir}/test"/>
    <property name="pa-ear.lib.main.dir" value="${pa-ear.lib.dir}/main"/>
    <property name="pa-ear.build.dir" value="${basedir}/target"/>
    <property name="pa-ear.build.outputDir" value="${pa-ear.build.dir}/classes"/>	
    <property name="pa-ear.build.testOutputDir" value="${pa-ear.build.dir}/test-classes"/>
    <property name="pa-ear.build.resourceDir.0" value="${basedir}/src/main/resources"/>	
    <property name="pa-ear.test.reports" value="${pa-ear.build.dir}/test-reports"/>
    <property name="pa-ear.build.testDir.0" value="${basedir}/src/test/java"/>
    <property name="pa-ear.build.testResourceDir.0" value="${basedir}/src/test/resources"/>
	<property name="pa-ear.build.finalName" value="pa"/>
	<property name="pa-ear.ear" value="${pa-ear.build.finalName}.ear"/>
	<property name="pa-ejb.output.dir" value="${basedir}/../pa-ejb/target"/>
	<property name="pa-ejb.package" value="${pa-ejb.output.dir}/pa-ejb.jar"/>
	<property name="pa-web.output.dir" value="${basedir}/../pa-web/target"/>
    <property name="pa-web.package" value="${pa-web.output.dir}/pa-web.war"/>
	
    <!-- ====================================================================== -->
    <!-- Defining classpaths                                                    -->
    <!-- ====================================================================== -->

    <path id="build.classpath">
        <fileset dir="${pa-ear.lib.main.dir}">
            <include name="**/*"/>
        </fileset>
    </path>
    <path id="build.test.classpath">
        <fileset dir="${pa-ear.lib.test.dir}"/>
        <fileset dir="${pa-ear.lib.main.dir}">
            <include name="**/*"/>
        </fileset>
        <fileset dir="${pa-ejb.output.dir}">
            <include name="pa-ejb.jar"/>
        </fileset>
    </path>
    <path id="jboss.classpath">       
    	<fileset dir="${jboss.deploy.directory}/../../../client">
    	    <include name="**/*"/>
    	</fileset>
    </path>
	
    <!-- ====================================================================== -->
    <!-- Cleaning up target                                                     -->
    <!-- ====================================================================== -->

    <target name="clean" description="Clean the output directory">
        <delete dir="${pa-ear.build.dir}"/>
    </target>

    <!-- ====================================================================== -->
    <!-- Compilation target                                                     -->
    <!-- ====================================================================== -->

    <target name="compile" description="Compile the code">
        <mkdir dir="${pa-ear.build.outputDir}"/>
      	<copy todir="${pa-ear.build.outputDir}">
      		<fileset dir="${pa-ear.build.resourceDir.0}"/>
      	</copy>
	</target>

	<!-- ====================================================================== -->
    <!-- Test-compilation target                                                -->
    <!-- ====================================================================== -->


    <target name="compile-tests" 
    	    description="Compile the test code" >
        <mkdir dir="${pa-ear.build.testOutputDir}"/>
        <javac destdir="${pa-ear.build.testOutputDir}" 
            nowarn="false" 
            debug="true" 
            optimize="false" 
            deprecation="true" 
            target="1.5" 
            verbose="false" 
            fork="false" 
            source="1.5">
            <src>
                <pathelement location="${pa-ear.build.testDir.0}"/>
            </src>
            <classpath>
                <path refid="build.test.classpath"/>
            </classpath>
        </javac>
        <copy todir="${pa-ear.build.testOutputDir}">
            <fileset dir="${pa-ear.build.testResourceDir.0}"/>
        </copy>
    </target>

    <!-- ====================================================================== -->
    <!-- Run JUnit Integration Tests                                            -->
    <!-- ====================================================================== -->

    <target name="test-all" depends="compile-tests" 
            description="Run JUnit integration tests">
        
        <mkdir dir="${pa-ear.test.reports}"/>
        <junit printSummary="yes" haltonerror="true" haltonfailure="true" fork="true" dir=".">
            <formatter type="xml"/>
            <formatter type="plain" usefile="false"/>             
        	<classpath refid="jboss.classpath"/>
        	<classpath refid="jboss.classpath"/>
            <classpath refid="build.test.classpath"/>
            <batchtest todir="${pa-ear.test.reports}">
                <fileset dir="${pa-ear.build.testDir.0}">
                    <include name="**/*Test.java"/>
                    <exclude name="**/*Abstract*Test.java"/>
                </fileset>
            </batchtest>
        </junit>
     </target>

	  <!-- ====================================================================== -->
	  <!-- Package target                                                         -->
	  <!-- ====================================================================== -->

	  <target name="package" depends="compile" description="Package the application">
        <available file="${pa-ejb.package}" property="pa-ejb.present"/>
        <fail unless="pa-ejb.present" message="EJB jar file not found."/>
        <available file="${pa-web.package}" property="pa-web.present"/>
        <fail unless="pa-web.present" message="War file not found."/>
	    <mkdir dir="${pa-ear.build.dir}/${pa-ear.build.finalName}"/>
	    <copy file="${pa-ejb.package}" 
	         todir="${pa-ear.build.dir}/${pa-ear.build.finalName}"/>
	    <copy file="${pa-web.package}" 
	         todir="${pa-ear.build.dir}/${pa-ear.build.finalName}"/>
	  	<!--copy todir="${pa-ear.build.dir}/${pa-ear.build.finalName}">
	  		 <fileset dir="${pa-ear.build.resourceDir.0}" includes="**/*"/>
	    </copy-->	  	
	  	<copy todir="${pa-ear.build.dir}/${pa-ear.build.finalName}/lib">
            <fileset dir="${pa-ear.lib.main.dir}" includes="*.jar"/>
            <fileset dir="${pa-ear.lib.main.dir}/jboss-client" includes="*.jar"/>
	  		<fileset dir="${pa-ear.lib.main.dir}" includes="postgresql-8.2-507.jdbc3.jar"/>
            
	    </copy>
	    <ear destfile="${pa-ear.build.dir}/${pa-ear.build.finalName}.ear" 
	         basedir="${pa-ear.build.dir}/${pa-ear.build.finalName}" 
	         compress="false" 
	         appxml="${pa-ear.build.dir}/classes/META-INF/application.xml"/>
	  </target>

    <!-- ====================================================================== -->
    <!-- Deploy locally                                                         -->
    <!-- ====================================================================== -->

    <target name="deploy" description="Deploys the ear for the application">
        <available file="${pa-ear.build.dir}/${pa-ear.ear}" property="pa-ear.ear.present"/>
        <fail unless="pa-ear.ear.present" message="Ear file not found."/>
        <copy todir="${jboss.deploy.directory}" file="${pa-ear.build.dir}/${pa-ear.ear}"/>
    </target>

    <!-- ====================================================================== -->
    <!-- A target to build and deploy the package                               -->
    <!-- ====================================================================== -->

    <target name="ear" depends="package,deploy" description="Builds and deploys the ear"/>

	
</project>